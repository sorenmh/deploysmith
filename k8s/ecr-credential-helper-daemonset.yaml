apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ecr-credential-helper-installer
  namespace: kube-system
  labels:
    app: ecr-credential-helper
spec:
  selector:
    matchLabels:
      app: ecr-credential-helper
  template:
    metadata:
      labels:
        app: ecr-credential-helper
    spec:
      hostPID: true
      hostNetwork: true
      tolerations:
      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: NoExecute
      initContainers:
      - name: ecr-credential-helper-installer
        image: alpine:3.18
        command:
        - /bin/sh
        - -c
        - |
          set -e

          echo "Installing ECR credential helper on node: $NODE_NAME"

          # Create directories
          chroot /host mkdir -p /usr/local/bin
          chroot /host mkdir -p /root/.aws

          # Download ECR credential helper
          wget -O /tmp/docker-credential-ecr-login \
            https://amazon-ecr-credential-helper-releases.s3.amazonaws.com/0.7.1/linux-amd64/docker-credential-ecr-login

          chmod +x /tmp/docker-credential-ecr-login
          cp /tmp/docker-credential-ecr-login /host/usr/local/bin/

          # Create AWS config
          cat > /host/root/.aws/config << 'EOF'
          [default]
          region = eu-central-1
          credential_source = Environment
          EOF

          # Update Docker daemon configuration
          DOCKER_CONFIG="/host/etc/docker/daemon.json"

          # Create docker directory if it doesn't exist
          chroot /host mkdir -p /etc/docker

          # Check if daemon.json exists and has content
          if [ -f "$DOCKER_CONFIG" ] && [ -s "$DOCKER_CONFIG" ]; then
            # Backup existing config
            cp "$DOCKER_CONFIG" "${DOCKER_CONFIG}.backup"

            # Merge ECR credential helper into existing config
            echo '{}' | jq --argjson existing "$(cat $DOCKER_CONFIG)" \
              --arg registry "$ECR_REGISTRY" \
              '$existing | .["credential-helpers"][$registry] = "ecr-login"' \
              > /tmp/daemon.json
          else
            # Create new daemon.json with ECR credential helper
            cat > /tmp/daemon.json << EOF
          {
            "credential-helpers": {
              "${ECR_REGISTRY}.dkr.ecr.${AWS_REGION}.amazonaws.com": "ecr-login"
            }
          }
          EOF
          fi

          cp /tmp/daemon.json "$DOCKER_CONFIG"

          # Signal that installation is complete
          touch /host/var/lib/ecr-credential-helper-installed

          echo "ECR credential helper installation completed on $NODE_NAME"

        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: ECR_REGISTRY
          valueFrom:
            secretKeyRef:
              name: deployment-api-secrets
              key: aws-account-id
        - name: AWS_REGION
          valueFrom:
            secretKeyRef:
              name: deployment-api-secrets
              key: aws-region
        volumeMounts:
        - name: host-root
          mountPath: /host
        securityContext:
          privileged: true
      containers:
      - name: credential-helper-monitor
        image: alpine:3.18
        command:
        - /bin/sh
        - -c
        - |
          # Keep container running and monitor for changes
          while true; do
            if [ ! -f /host/var/lib/ecr-credential-helper-installed ]; then
              echo "ECR credential helper not found, installation may have failed"
            fi
            sleep 300  # Check every 5 minutes
          done
        volumeMounts:
        - name: host-root
          mountPath: /host
          readOnly: true
        resources:
          requests:
            memory: "16Mi"
            cpu: "10m"
          limits:
            memory: "32Mi"
            cpu: "50m"
      volumes:
      - name: host-root
        hostPath:
          path: /
          type: Directory
      restartPolicy: Always

# Note: This DaemonSet uses the existing deployment-api-secrets
# Copy the secret to kube-system namespace:
# kubectl get secret deployment-api-secrets -o yaml | \
#   sed 's/namespace: default/namespace: kube-system/' | \
#   kubectl apply -f -

---
apiVersion: batch/v1
kind: Job
metadata:
  name: docker-restart-job
  namespace: kube-system
spec:
  parallelism: 1
  completions: 1
  backoffLimit: 3
  template:
    spec:
      hostPID: true
      hostNetwork: true
      tolerations:
      - operator: Exists
        effect: NoSchedule
      containers:
      - name: docker-restarter
        image: alpine:3.18
        command:
        - /bin/sh
        - -c
        - |
          echo "Restarting Docker daemon to apply ECR credential helper configuration..."

          # Wait a bit to ensure DaemonSet has completed
          sleep 30

          # Check if systemctl is available (systemd systems)
          if chroot /host which systemctl >/dev/null 2>&1; then
            echo "Restarting Docker via systemctl..."
            chroot /host systemctl restart docker
          elif chroot /host which service >/dev/null 2>&1; then
            echo "Restarting Docker via service command..."
            chroot /host service docker restart
          else
            echo "Warning: Could not find systemctl or service command"
            echo "Please manually restart Docker daemon on all nodes"
          fi

          echo "Docker restart job completed"
        volumeMounts:
        - name: host-root
          mountPath: /host
        securityContext:
          privileged: true
      volumes:
      - name: host-root
        hostPath:
          path: /
          type: Directory
      restartPolicy: Never